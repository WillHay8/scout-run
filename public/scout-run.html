<!DOCTYPE html>
<html>
  <head>
    <title>Scout Run</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="https://scoutrun.codio.dev/images/player-left-foot-forward-1.png">
    <style>
      html, body {
        width: 100%;
        height: 100%;
        margin: 0;
        font-family: "Lucida Sans Unicode", "Lucida Grande", sans-serif;
        font-size: 20px;
        line-height: 27px;
      }
      h1 {
        font-size: 50px;
      }
      h2 {
        font-size: 35px;
      }
      h3 {
        font-size: 25px;
      }
      button {
        font-size: 21px;
        font-weight: bold;
      }
      ul {
        list-style: none;
        padding: 0;
        margin: 0 10px;
      }
      li {
        margin-top: 8px;
      }

      img {
        display: none;
      }

      #pre-game-background, #post-game-background {
        position: absolute;
        width: 100%;
        height: 100%;
        background-color: white;
        text-align: center;
      }
      #loading-icon, #start-game, #play-again{
        width: 300px;
        height: 50px;
      }
      #loading-icon, #start-game, #play-again{
        left: 0;
        right: 0;
        position: absolute;
        border: none;
        padding: 0;
        margin: 0;
        border-radius: 5px;
      }
      #pre-game-con {
        position: relative;
        margin: auto;
        margin-top: 100px;
        width: 400px;
        max-width: 100%;
        height: 430px;
        padding: 30px;
        background-color: #fdfdfd;
        box-shadow: 5px 5px 10px rgba(0,0,0,0.3);
      }
      #loading-icon {
        color: black;
        line-height: 50px;
        text-align: center;
        background-color: red;
      }
      #start-game, #play-again {
        background-color: #33ee33;
      }
      #start-game {
        position: absolute;
        display: none;
        margin: auto;
        margin-top: 25px;
      }
      #post-game-background {
        display: none;
        background-color: rgba(255,255,255,0.75);
        text-align: center;
      }
      #post-game-con {
        position: relative;
        top: 50%;
      }
      #game-over {
        position: relative;
        margin-top: -90px;
        font-size: 50px;
        font-weight: bold;
      }
      #score-con {
        margin-top: 15px;
        font-size: 30px;
        font-weight: bold;
      }
      #play-again {
        position: relative;
        display: inline-block;
        margin: auto;
        margin-top: 30px;
      }
      .blurb {
        margin-top: 30px;
      }
      .controls {
        margin-top: 40px;
      }

      button:hover {
        cursor: pointer;
        background-color: black;
        color: white;
      }

    </style>
  </head>
  <body>

    <img id="background" src="https://scoutrun.codio.dev/images/background-1.png">

    <img id="jump-obstacle" src="https://scoutrun.codio.dev/images/fire-1.png">

    <img id="slide-obstacle" src="https://scoutrun.codio.dev/images/tent-1.png">

    <img id="player-run-1" src="https://scoutrun.codio.dev/images/player-left-foot-forward-1.png">

    <img id="player-run-2" src="https://scoutrun.codio.dev/images/player-middle-1.png">

    <img id="player-run-3" src="https://scoutrun.codio.dev/images/player-right-foot-forward-1.png">

    <img id="player-jump" src="https://scoutrun.codio.dev/images/player-jump-1.png">

    <img id="player-slide" src="https://scoutrun.codio.dev/images/player-slide-1.png">

    <div id="pre-game-background">
      <div id="pre-game-con">
        <h1>Scout Run</h1>
        <p class="blurb">As you run along, jump over the camp fires and slide through the tents to stay alive at camp</p>
        <h3 class="controls">Controls:</h3>
        <ul>
          <li>Press Up to Jump</li>
          <li>Press Down to Slide</li>
        </ul>
        <div id="loading-icon">Loading Game...</div>
        <button id="start-game">PLAY</button>
      </div>
    </div>

    <div id="post-game-background">
      <div id="post-game-con">
        <div id="game-over">GAME OVER</div>
        <div id="score-con"><span>Distance Run: </span><span id="score"></span><span>m</span></div>
        <button id="play-again">PLAY AGAIN</div>
      </div>
    </div>



    <canvas></canvas>
    <script>
      console.log('scout run start');



      /*

      GAME PROPERTIES

      */

      const initialScrollSpeedUnitsPerSecond = 10;

      const scrollSpeedIncreasePerLevelUnitsPerSecond = 2;

      const jumpSpeedUnitsPerSecond = 25;

      const gravitationalAccelerationUnitsPerSecond = 1.5;

      // milliseconds
      const strideTimePeriod = 140;

      const fps = 30;

      const minimumGapBetweenObstaclesInUnits = 6;

      const obstacleGenerationProbabilityPerSecond = 0.7;

      const objectCollisionOverlapInUnits = 0.4;

      const initialDelayBeforeObstacles = 2000; // milliseconds

      const levelTime = 15000; //milliseconds

      const levelUpTime = 1500; // milliseconds

      //This object defines the size of the images relative to each other.
      const gameSizes = {
        playerRun: {
          width: 3,
          height: 4
        },
        playerJump: {
          width: 3,
          height: 3
        },
        playerSlide: {
          width: 4,
          height: 2
        },
        jumpObstacle: {
          width: 3,
          height: 2
        },
        slideObstacle: {
          width: 5,
          height: 3
        },
        groundHeight: 2,
        gameHeight: 20,
        getBackgroundHeight: function(){ return this.gameHeight - this.groundHeight },
        playerHorizontalPosition: 7
      }

      const stepSequence = [1,2,3,2];






      /*

      GAME PROPERTY GETTERS

      */

      //standard unit for the sizing the objects in the game
      const getUnit = function() {
        return window.innerHeight/gameSizes.gameHeight;
      }
      //in pixelsPerMilli
      const getScrollSpeed = function(){
        return gameVars.currentScrollSpeedUnitsPerSecond * getUnit() / 1000;
      }

      const getJumpVelocity = function(){
        return -1 * jumpSpeedUnitsPerSecond * getUnit() / 1000;
      }

      const getGravitationalAcceleration = function(){
        return gravitationalAccelerationUnitsPerSecond * getUnit() / 1000;
      }

      const getMinimumGapBetweenObstacles = function(){
        return minimumGapBetweenObstaclesInUnits * getUnit();
      }

      const getObstacleGenerationProbability = function(){
        return obstacleGenerationProbabilityPerSecond / 1000;
      }





      /*

      START DOM DEPENDENT ACTIONS

      */

      const runDomOperations = function(){

        /*

        CREATE IMAGE ELEMENT CONSTANTS

        */

        const backgroundImg = document.getElementById('background');
        const playerJumpImg = document.getElementById('player-jump');
        const playerSlideImg = document.getElementById('player-slide');
        const playerRun1Img = document.getElementById('player-run-1');
        const playerRun2Img = document.getElementById('player-run-2');
        const playerRun3Img = document.getElementById('player-run-3');
        const jumpObstacleImg = document.getElementById('jump-obstacle');
        const slideObstacleImg = document.getElementById('slide-obstacle');

        var totalImages = 8;

        var imagesLoadedCount = 0;



        /*

        DEFINE GAME OBJECTS

        */

        const context = document.querySelector("canvas").getContext("2d");

        const player = {
          height: 1,
          width: 1,
          jumping: false,
          sliding: false,
          x: 1,
          y: 1,
          yVelocity: 0,
          runPosition: 1,
          runNextPosition: 2
        }

        const backgroundSize = {
          imageAspectRatio: 1,
          width: 1,
          height: 1
        }

        const background1 = {
          x: 0,
          primary: true
        }

        const background2 = {
          x: 0,
          primary: false
        }

        const controller = {
          jump: false,
          slide: false,

          keyListener: function(event){
            let keyState = (event.type == "keydown") ? true : false;

            switch (event.keyCode) {
              case 38: // up arrow
              case 87: // w
              case 73: // i
              case 36: // pageup
              case 49: // 1
              case 32: // space bar
                controller.jump = keyState;
                break;
              case 40: // down arrow
              case 83: // s
              case 75: // k
              case 35: // pagedown
              case 50: // 2
              case 66: // b
              case 93: // command
              case 18: // alt
              case 17: // constrol
                controller.slide = keyState;
                break;
            }
          },
          touchListener: function(event){
            if(event.type == 'touchstart'){
              this.firstTouch = getTouches(evt)[0];
              this.xDown = firstTouch.clientX;
              this.yDown = firstTouch.clientY;
            }
            else if(event.type == 'touchmove'){
              if ( ! this.xDown || ! this.yDown ) {
                return;
              }

              let xUp = evt.touches[0].clientX;
              let yUp = evt.touches[0].clientY;

              let xDiff = this.xDown - xUp;
              let yDiff = this.yDown - yUp;

              if ( Math.abs( xDiff ) > Math.abs( yDiff ) ) {/*most significant*/
                  if ( xDiff > 0 ) {
                      /* left swipe */
                  } else {
                      /* right swipe */
                  }
              } else {
                  if ( yDiff > 0 ) {
                      /* up swipe */
                      console.log('up swipe');
                  } else {
                      /* down swipe */
                      console.log('down swipe');
                  }
              }
              /* reset values */
              this.xDown = null;
              this.yDown = null;
            }

function getTouches(evt) {
  return evt.touches ||             // browser API
         evt.originalEvent.touches; // jQuery
}

function handleTouchStart(evt) {

};

function handleTouchMove(evt) {

};
          }
        }

        function JumpObstacle(){
          this.obstacleType = 'jump';
          this.x = context.canvas.width,
          this.y = (gameSizes.gameHeight - gameSizes.groundHeight - gameSizes.jumpObstacle.height) * getUnit(),
          this.width = gameSizes.jumpObstacle.width * getUnit(),
          this.height = gameSizes.jumpObstacle.height * getUnit()
        }

        function SlideObstacle(){
          this.obstacleType = 'slide';
          this.x = context.canvas.width,
          this.y = (gameSizes.gameHeight - gameSizes.groundHeight - gameSizes.slideObstacle.height) * getUnit(),
          this.width = gameSizes.slideObstacle.width * getUnit(),
          this.height = gameSizes.slideObstacle.height * getUnit()
        }

        /*

        Initialise Loop Variables

        */
        function GameVars(){
          this.startTime = 0;
          this.runTime = 0;
          this.runDistance = 0;
          this.frameCount = 0;
          this.lastFrameRunTime = 0;
          this.lastFrameRunDistance = 0;
          this.currentScrollSpeedUnitsPerSecond = initialScrollSpeedUnitsPerSecond;
          this.currentLevel = 1;
          this.levelUp = false;
          this.lastLevelUpTime = 0;
          this.gameOver = false;
          this.score = {
            value: 0,
            x: 0,
            y: 40
          },
          this.obstacles = []
        }

        /*

        DEFINE FUNCTIONS TO RESIZE ALL OBJECTS TO WINDOW SIZE

        */

        const resizeCanvas = function(){
          context.canvas.width = window.innerWidth;
          context.canvas.height = window.innerHeight;
        }

        const resizeBackground = function(){
          backgroundSize.imageAspectRatio = backgroundImg.naturalWidth / backgroundImg.naturalHeight;
          backgroundSize.height = gameSizes.getBackgroundHeight() * getUnit();
          backgroundSize.width = backgroundSize.height * backgroundSize.imageAspectRatio;
        }

        const resizePlayer = function(){
          if(player.jumping){
            player.height = gameSizes.playerJump.height * getUnit();
            player.width = gameSizes.playerJump.width * getUnit();
          }
          else if(player.sliding){
            player.height = gameSizes.playerSlide.height * getUnit();
            player.width = gameSizes.playerSlide.width * getUnit();
          }
          else{
            player.height = gameSizes.playerRun.height * getUnit();
            player.width = gameSizes.playerRun.width * getUnit();
            player.x = gameSizes.playerHorizontalPosition * getUnit();
            player.y = (gameSizes.gameHeight - gameSizes.groundHeight - gameSizes.playerRun.height) * getUnit();
          }
        }

        var windowResized = false;
        window.onresize = function(){
          windowResized = true;
        }
        const resizeAll = function(){
          resizeCanvas();
          resizeBackground();
          resizePlayer();
          windowResized = false;
        }




        /*

        PREPARE GAME STATE

        */

        const startGame = function(){
          document.getElementById('pre-game-background').style.display = 'none';
          document.getElementById('post-game-background').style.display = 'none';
          window.requestAnimationFrame(loop);
        }

        const setGameReady = function(){
          currentPlayerImg = '';
          gameVars = new GameVars();
          resizeAll();
          document.getElementById('loading-icon').style.display = 'none';
          document.getElementById('start-game').style.display = 'block';
          document.getElementById('start-game').addEventListener('click', startGame);
          document.getElementById('play-again').addEventListener('click', restartGame);
        }

        const increaseImageLoadedCount = function(index){
          imagesLoadedCount++;
          if(imagesLoadedCount == totalImages){
            setGameReady();
          }
        }

        const setImageLoadEventListeners = function(){
          backgroundImg.addEventListener('load', increaseImageLoadedCount, false);
          playerJumpImg.addEventListener('load', increaseImageLoadedCount, false);
          playerSlideImg.addEventListener('load', increaseImageLoadedCount, false);
          playerRun1Img.addEventListener('load', increaseImageLoadedCount, false);
          playerRun2Img.addEventListener('load', increaseImageLoadedCount, false);
          playerRun3Img.addEventListener('load', increaseImageLoadedCount, false);
          jumpObstacleImg.addEventListener('load', increaseImageLoadedCount, false);
          slideObstacleImg.addEventListener('load', increaseImageLoadedCount, false);
        };

        setImageLoadEventListeners();




        /*

        GAME OVER METHODS

        */
        const executeGameOver = function(){
          document.getElementById('post-game-background').style.display = 'block';
          document.getElementById('score').innerHTML = gameVars.score.value;
        }

        const restartGame = function(){
          gameVars = new GameVars();
          startGame();
        }




        /*

        GAME LOOP

        */

        const loop = function(timeStamp) {
          if(gameVars.runTime == 0){
            gameVars.startTime = timeStamp - 1;
          }
          gameVars.runTime = timeStamp - gameVars.startTime;
          if(Math.floor(gameVars.runTime/(1000/fps)) > gameVars.frameCount){
            gameVars.frameCount++;

            if(windowResized){
              resizeAll();
            }

            // Jump if told
            if(controller.jump && player.jumping == false){
              player.sliding = false;
              player.yVelocity = getJumpVelocity();

              player.jumping = true;
              player.width = gameSizes.playerJump.width * getUnit();
              player.height = gameSizes.playerJump.height * getUnit();
              currentPlayerImg = playerJumpImg;
            }

            //apply gravity and move with y current velocity
            if(player.jumping){
              player.yVelocity += getGravitationalAcceleration();

              player.y += (gameVars.runTime - gameVars.lastFrameRunTime) * player.yVelocity;
            }

            //stop player falling through the floor
            if(player.jumping && player.y > (gameSizes.gameHeight - gameSizes.groundHeight - gameSizes.playerRun.height) * getUnit()){
              player.jumping = false;
              player.yVelocity = 0;
              currentPlayerImg = playerRun2Img;
              player.width = gameSizes.playerRun.width * getUnit();
              player.height = gameSizes.playerRun.height * getUnit();
              player.y = (gameSizes.gameHeight - gameSizes.groundHeight - gameSizes.playerRun.height) * getUnit();
            }

            //slide if told
            if(!player.jumping && controller.slide){
              player.sliding = true;
              player.slideStartTime = gameVars.runTime;
              currentPlayerImg = playerSlideImg;
              player.width = gameSizes.playerSlide.width * getUnit();
              player.height = gameSizes.playerSlide.height * getUnit();
              player.y = (gameSizes.gameHeight - gameSizes.groundHeight - gameSizes.playerSlide.height) * getUnit();
            }

            //stop sliding if time is up
            if(player.sliding){
              let slideDuration = (gameSizes.slideObstacle.width + 2 * gameSizes.playerSlide.width) * getUnit() / getScrollSpeed();
              if(gameVars.runTime - player.slideStartTime >  slideDuration){
                player.sliding = false;
                player.y = (gameSizes.gameHeight - gameSizes.groundHeight - gameSizes.playerRun.height) * getUnit();
                currentPlayerImg = playerRun2Img;
                player.width = gameSizes.playerRun.width * getUnit();
                player.height = gameSizes.playerRun.height * getUnit();
              }
            }

            //runNextPosition
            if(!player.sliding && !player.jumping){
              runPosition = stepSequence[Math.floor(gameVars.runTime/strideTimePeriod%stepSequence.length)];
              switch (runPosition){
                case 1:
                  currentPlayerImg = playerRun1Img;
                  break;
                case 2:
                  currentPlayerImg = playerRun2Img;
                  break;
                case 3:
                  currentPlayerImg = playerRun3Img;
              }
            }

            //position backgrounds
            gameVars.runDistance = gameVars.runTime * getScrollSpeed();
            let primaryBackgroundNumber = Math.floor(gameVars.runDistance / backgroundSize.width);
            background1.x = -gameVars.runDistance + backgroundSize.width * primaryBackgroundNumber;
            background2.x = background1.x + backgroundSize.width;

            //place obstacles
            if(gameVars.runTime > initialDelayBeforeObstacles){
              if(gameVars.obstacles.length == 0 || gameVars.obstacles[gameVars.obstacles.length - 1].x + gameVars.obstacles[gameVars.obstacles.length - 1].width + getMinimumGapBetweenObstacles() < context.canvas.width){
                if(Math.random() < (gameVars.runTime - gameVars.lastFrameRunTime) * getObstacleGenerationProbability()){
                  if(Math.random() > 0.5){
                    gameVars.obstacles.push(new JumpObstacle());
                  }
                  else {
                    gameVars.obstacles.push(new SlideObstacle());
                  }
                }
                gameVars.lastFrameRunTime = gameVars.runTime;
              }
            }

            //move obstacles with background
            gameVars.obstacles.forEach(function(obstacle, index){
              obstacle.x -= gameVars.runDistance - gameVars.lastFrameRunDistance;
            });


            //check collision with obstacles
            let objectCollisionOverlap = objectCollisionOverlapInUnits * getUnit();
            gameVars.obstacles.forEach(function(obstacle, index){
              // jumpObstacles
              if(obstacle.obstacleType == 'jump'){
                // check x overlap
                if((obstacle.x + obstacle.width) - player.x > objectCollisionOverlap && (player.x + player.width) - obstacle.x > objectCollisionOverlap){
                  //check y overlap
                  if((obstacle.y + obstacle.height) - player.y > objectCollisionOverlap  && (player.y + player.height) - obstacle.y > objectCollisionOverlap){
                    gameVars.gameOver = true;
                  }
                }
              }
              else if(obstacle.obstacleType == 'slide'){
                // check x overlap
                if((obstacle.x + obstacle.width) - player.x > objectCollisionOverlap && (player.x + player.width) - obstacle.x > objectCollisionOverlap){
                  //check player not overlapping with slideObstacle top
                  if(obstacle.y - player.y > objectCollisionOverlap && (player.y + player.height) - obstacle.y > objectCollisionOverlap){
                    gameVars.gameOver = true;
                  }
                }
              }
            });

            // update score
            gameVars.score.value = Math.floor(gameVars.runDistance / getUnit());
            gameVars.score.x = context.canvas.width / 2 - 150;

/*
            //level up if time has passed
            if(gameVars.runTime / levelTime > gameVars.currentLevel){
              gameVars.levelUp = true;
              gameVars.currentLevel++;
              console.log('level: '+gameVars.currentLevel);
              gameVars.currentScrollSpeedUnitsPerSecond += scrollSpeedIncreasePerLevelUnitsPerSecond;
              gameVars.lastLevelUpTime = gameVars.runTime;
            }
            if(gameVars.levelUp == true && gameVars.runTime > gameVars.lastLevelUpTime + levelUpTime){
              gameVars.levelUp = false;
            }
*/

            redraw();

            gameVars.lastFrameRunTime = gameVars.runTime;
            gameVars.lastFrameRunDistance = gameVars.runDistance;
          }

          if(gameVars.gameOver){
            executeGameOver();
          }
          else{
            window.requestAnimationFrame(loop);
          }
        }




        /*

        DRAW Loop

        */

        const redraw = function(){
          //drawBackground
          context.drawImage(backgroundImg, background1.x, 0, backgroundSize.width, backgroundSize.height);
          context.drawImage(backgroundImg, background2.x, 0, backgroundSize.width, backgroundSize.height);


          //drawPlayer
          context.drawImage(currentPlayerImg, player.x, player.y, player.width, player.height);

          //drawGround
          context.fillStyle = "#4b2400";
          context.fillRect(0, gameSizes.getBackgroundHeight()*getUnit(), context.canvas.width, gameSizes.groundHeight*getUnit()); // x, y, width, height
          context.fillStyle = "#085500";
          context.fillRect(0, gameSizes.getBackgroundHeight()*getUnit(), context.canvas.width, gameSizes.groundHeight*getUnit()/5); // x, y, width, height

          //draw obstacles
          gameVars.obstacles.forEach(function(obstacle, index){
            if(obstacle.obstacleType == 'jump'){
              context.drawImage(jumpObstacleImg, obstacle.x, obstacle.y, obstacle.width, obstacle.height);
            }
            else if (obstacle.obstacleType == 'slide'){
              context.drawImage(slideObstacleImg, obstacle.x, obstacle.y, obstacle.width, obstacle.height);
            }
          });

          // draw score
          context.fillStyle = "#854900";
          context.font = '30px "Lucida Sans Unicode", "Lucida Grande", sans-serif';
          context.fillText("Distance Run: "+gameVars.score.value+"m", gameVars.score.x, gameVars.score.y);

/*
          // draw level up
          if(gameVars.levelUp){
            context.fillStyle = "#dd3333";
            context.font = '50px "Lucida Sans Unicode", "Lucida Grande", sans-serif';
            context.fillText("Level Up!", context.canvas.width / 2 - 100, context.canvas.height / 2 - 70);
          }
*/
        }

        window.addEventListener('keydown', controller.keyListener);
        window.addEventListener('keyup', controller.keyListener);
        window.addEventListener('touchstart', controller.touchListener, false);
        window.addEventListener('touchmove', controller.touchListener, false);

      }

      document.addEventListener('DOMContentLoaded', runDomOperations, false);
    </script>
  </body>

</html>
